#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <DHT.h>

// ==================== KONFIGURASI NETWORK ====================
const char* ssid = "smk unnes semarang";
const char* password = "12345678";
const char* gatewayIP = "192.168.137.240";  // ⚠️ SESUAIKAN DENGAN IP GATEWAY!
const int gatewayPort = 8080;

// ==================== KONFIGURASI HARDWARE ====================
#define DHT_PIN 4
#define RELAY_PIN 2
#define DHT_TYPE DHT22
#define NODE_ID 1  // ⚠️ UBAH UNTUK SETIAP NODE (1-4)
#define RELAY_ACTIVE_LOW true

// ==================== SENSOR & KONTROL ====================
DHT dht(DHT_PIN, DHT_TYPE);
int exhaust_status = 0;  // 0=MATI, 1=SEDANG, 2=MENYALA
bool manual_mode = false;

// Current sensor readings
float current_temperature = NAN;
float current_humidity = NAN;

// ==================== TIMING ====================
unsigned long last_sensor_read = 0;
unsigned long last_gateway_sync = 0;
unsigned long last_status_print = 0;

const unsigned long SENSOR_INTERVAL = 2000;   // Baca sensor setiap 2 detik
const unsigned long SYNC_INTERVAL = 5000;     // Sync ke gateway setiap 5 detik
const unsigned long PRINT_INTERVAL = 10000;   // Print status setiap 10 detik

// ==================== FUNGSI RELAY ====================
void setExhaust(int status) {
  bool relay_on = (status > 0);  // ON jika SEDANG (1) atau MENYALA (2)
  bool output_level = RELAY_ACTIVE_LOW ? !relay_on : relay_on;
  digitalWrite(RELAY_PIN, output_level);
  exhaust_status = status;
  
  const char* status_names[] = {"MATI", "SEDANG", "MENYALA"};
  Serial.printf("[EXHAUST] Status set to: %s (%d)\n", status_names[status], status);
}

// ==================== FUNGSI SENSOR ====================
void readSensors() {
  current_temperature = dht.readTemperature();
  current_humidity = dht.readHumidity();
  
  int retries = 3;
  while ((isnan(current_temperature) || isnan(current_humidity)) && retries > 0) {
    delay(500);
    current_temperature = dht.readTemperature();
    current_humidity = dht.readHumidity();
    retries--;
  }
  
  if (isnan(current_temperature) || isnan(current_humidity)) {
    Serial.println("[ERROR] Unable to read DHT sensor");
    current_temperature = 0.0;
    current_humidity = 0.0;
  }
}

// ==================== SYNC DENGAN GATEWAY ====================
void syncWithGateway() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("[ERROR] WiFi not connected");
    return;
  }
  
  HTTPClient http;
  String url = "http://" + String(gatewayIP) + ":" + String(gatewayPort) + "/api/node/sync";
  
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  http.setTimeout(5000);
  
  // Prepare data
  DynamicJsonDocument doc(1024);
  doc["node_id"] = NODE_ID;
  doc["node_type"] = "exhaust";
  doc["temperature"] = round(current_temperature * 10) / 10.0;
  doc["humidity"] = round(current_humidity * 10) / 10.0;
  doc["exhaust_status"] = exhaust_status;
  doc["mode"] = manual_mode ? "MANUAL" : "AUTO";
  doc["timestamp"] = millis();
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  // Send POST request
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode == 200) {
    String response = http.getString();
    
    DynamicJsonDocument responseDoc(512);
    DeserializationError error = deserializeJson(responseDoc, response);
    
    if (!error) {
      // Update mode dari gateway
      if (responseDoc.containsKey("mode")) {
        String mode = responseDoc["mode"].as<String>();
        bool new_manual_mode = (mode == "MANUAL");
        
        if (new_manual_mode != manual_mode) {
          Serial.printf("[GATEWAY] Mode changed: %s -> %s\n", 
                        manual_mode ? "MANUAL" : "AUTO",
                        new_manual_mode ? "MANUAL" : "AUTO");
          manual_mode = new_manual_mode;
        }
      }
      
      // Jika mode MANUAL, ambil command dari gateway
      if (manual_mode && responseDoc.containsKey("actuator_command")) {
        bool command = responseDoc["actuator_command"];
        int new_status = command ? 2 : 0;  // ON=MENYALA(2), OFF=MATI(0)
        
        if (new_status != exhaust_status) {
          Serial.printf("[GATEWAY] Manual command: %s\n", command ? "ON" : "OFF");
          setExhaust(new_status);
        }
      }
      
      // Jika mode AUTO, ambil fuzzy result dari gateway
      if (!manual_mode && responseDoc.containsKey("fuzzy_exhaust_status")) {
        int fuzzy_status = responseDoc["fuzzy_exhaust_status"];
        
        if (fuzzy_status != exhaust_status) {
          Serial.printf("[GATEWAY] Fuzzy control: %d -> %d\n", exhaust_status, fuzzy_status);
          setExhaust(fuzzy_status);
        }
      }
      
      Serial.printf("[SYNC] ✓ Success (Node %d) - Mode: %s\n", 
                    NODE_ID, 
                    manual_mode ? "MANUAL" : "AUTO-FUZZY");
    } else {
      Serial.printf("[SYNC] ✗ JSON parse error: %s\n", error.c_str());
    }
  } else {
    Serial.printf("[SYNC] ✗ HTTP error: %d\n", httpResponseCode);
  }
  
  http.end();
}

// ==================== PRINT STATUS ====================
void printStatus() {
  Serial.println("\n===============================================");
  Serial.printf("[NODE %d] Exhaust Control System\n", NODE_ID);
  Serial.println("===============================================");
  
  Serial.printf("[SENSOR]  Temp: %.1f°C | Humidity: %.1f%%\n", 
                current_temperature, current_humidity);
  
  Serial.printf("[EXHAUST] Status: ");
  switch(exhaust_status) {
    case 0: Serial.println("MATI (0)"); break;
    case 1: Serial.println("SEDANG (1)"); break;
    case 2: Serial.println("MENYALA (2)"); break;
    default: Serial.println("UNKNOWN"); break;
  }
  
  Serial.printf("[MODE]    %s\n", manual_mode ? "MANUAL (Gateway)" : "AUTO (Fuzzy)");
  
  Serial.printf("[GATEWAY] %s:%d - %s\n", 
                gatewayIP, 
                gatewayPort,
                WiFi.status() == WL_CONNECTED ? "Connected" : "Disconnected");
  
  Serial.println("===============================================\n");
}

// ==================== SETUP ====================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n========================================");
  Serial.printf("ESP32 Node Sensor 1 (DHT + Exhaust)\n");
  Serial.printf("Node ID: %d\n", NODE_ID);
  Serial.println("========================================\n");
  
  // Initialize pins
  pinMode(RELAY_PIN, OUTPUT);
  setExhaust(0);  // Start dengan exhaust MATI
  
  // Initialize DHT
  dht.begin();
  Serial.println("✓ DHT sensor initialized");
  
  // Connect WiFi
  Serial.printf("Connecting to WiFi: %s\n", ssid);
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  WiFi.setAutoReconnect(true);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("✓ WiFi connected!");
    Serial.printf("  Node IP: %s\n", WiFi.localIP().toString().c_str());
    Serial.printf("  Gateway: %s:%d\n", gatewayIP, gatewayPort);
  } else {
    Serial.println("✗ WiFi connection failed!");
  }
  
  Serial.println("\n╔════════════════════════════════════════╗");
  Serial.printf("║  Node ID      : %-23d║\n", NODE_ID);
  Serial.printf("║  Type         : %-23s║\n", "DHT22 + Exhaust");
  Serial.printf("║  Control Mode : %-23s║\n", "AUTO (Fuzzy Mamdani)");
  Serial.println("╠════════════════════════════════════════╣");
  Serial.println("║  Fuzzy Logic akan dijalankan di        ║");
  Serial.println("║  GATEWAY, bukan di node ini!           ║");
  Serial.println("╚════════════════════════════════════════╝\n");
  
  // Initial sensor read
  readSensors();
  
  // Initial sync
  syncWithGateway();
  
  Serial.println("System ready!\n");
}

// ==================== LOOP ====================
void loop() {
  unsigned long now = millis();
  
  // Check WiFi
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("[WiFi] Reconnecting...");
    WiFi.reconnect();
    delay(5000);
    return;
  }
  
  // Read sensors
  if (now - last_sensor_read >= SENSOR_INTERVAL) {
    readSensors();
    last_sensor_read = now;
  }
  
  // Sync with gateway
  if (now - last_gateway_sync >= SYNC_INTERVAL) {
    syncWithGateway();
    last_gateway_sync = now;
  }
  
  // Print status
  if (now - last_status_print >= PRINT_INTERVAL) {
    printStatus();
    last_status_print = now;
  }
  
  delay(100);
}
